!function(t,d){"use strict";var i=t.module("angular-img-cropper",[]);i.factory("__extends",function(){var t=t||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);function o(){this.constructor=t}o.prototype=i.prototype,t.prototype=new o};return t}),i.directive("imgCropper",["$document","$window","ImageCropper",function(t,i,l){return{scope:{imgSrc:"=",imgDst:"=",cropWidth:"=",cropHeight:"=",keepAspect:"=",keepAspectRatio:"=",touchRadius:"=",cropAreaBounds:"=",minWidth:"=",minHeight:"=",enforceCropAspect:"=",enforceFileType:"@",color:"@",colorDrag:"@",colorBg:"@",colorCropBg:"@"},restrict:"A",link:function(h,t,c){var g,u=t[0];function i(t,i){if(!g||t!==i){var e=h.cropWidth,o=h.cropHeight,s=h.keepAspect,n=h.keepAspectRatio,r=h.touchRadius,a=g&&g.srcImage;g=new l(u,u.width/2-e/2,u.height/2-o/2,e,o,s,n,r,h,c),d(u).data("crop.angular-img-cropper",g),a?g.setImage(a,h.imgSrc.fileType):p(h.imgSrc)}}function p(t){if(t){var i=new Image;void 0!==c.cors&&"no"!==c.cors&&(i.crossOrigin="Anonymous"),i.addEventListener("load",function(){g.setImage(i,t.fileType),h.$apply()},!1),i.src=t.imageData}}h.color=h.color||"rgba(90,90,90,0.75)",h.colorDrag=h.colorDrag||"rgba(0, 0, 0, 0.7)",h.colorBg=h.colorBg||"rgba(192,192,192,1)",h.colorCropBg=h.colorCropBg||"rgba(0, 0, 0, 0.7)",h.$on("$destroy",function(){!0}),h.$watch("cropWidth",i),h.$watch("cropHeight",i),h.$watch("keepAspect",i),h.$watch("touchRadius",i),h.$watch("imgSrc",p)}}}])}(angular,angular.element),function(o,t,i){"use strict";angular.module("angular-img-cropper").directive("imgCropperFilereadCall",function(){return{scope:{control:"="},link:function(t){t.internalControl=t.control||{},t.internalControl.load=function(t){var i=o.element(document.querySelector(t)),e=document.createEvent("MouseEvent");e.initEvent("click",!0,!1),i[0].dispatchEvent(e)}}}})}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").directive("imgCropperFileread",["$timeout",function(s){return{scope:{image:"="},link:function(o,t){t.bind("change",function(t){var i=new FileReader,e=this;i.onload=function(i){s(function(){var t=e;o.image={imageData:i.target.result,fileType:t.fileType}},0)},t.target.files[0]&&(e.fileType=t.target.files[0].type,i.readAsDataURL(t.target.files[0]))})}}}])}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").factory("Bounds",["PointPool",function(e){function t(t,i,e,o){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===o&&(o=0),this.left=t,this.right=t+e,this.top=i,this.bottom=i+o}return t.prototype.getWidth=function(){return this.right-this.left},t.prototype.getHeight=function(){return this.bottom-this.top},t.prototype.getCentre=function(){var t=this.getWidth(),i=this.getHeight();return e.instance.borrow(this.left+t/2,this.top+i/2)},t}])}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").factory("CornerMarker",["Handle","__extends",function(t,i){return function(n){function t(t,i,e,o,s){n.call(this,t,i,e),this.color="rgba(90,90,90,0.75)"|o,this.colorCropBg="rgba(0,0,0,1)"|s}return i(t,n),t.prototype.drawCornerBorder=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,o=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(o=-1),t.beginPath(),t.lineJoin="miter",t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*o),t.lineTo(this.position.x,this.position.y+i*o),t.lineTo(this.position.x,this.position.y),t.closePath(),t.lineWidth=2,t.strokeStyle=this.color,t.stroke()},t.prototype.drawCornerFill=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,o=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(o=-1),t.beginPath(),t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*o),t.lineTo(this.position.x,this.position.y+i*o),t.lineTo(this.position.x,this.position.y),t.closePath(),t.fillStyle=this.colorCropBg,t.fill()},t.prototype.moveX=function(t){this.setPosition(t,this.position.y)},t.prototype.moveY=function(t){this.setPosition(this.position.x,t)},t.prototype.move=function(t,i){this.setPosition(t,i),this.verticalNeighbour.moveX(t),this.horizontalNeighbour.moveY(i)},t.prototype.addHorizontalNeighbour=function(t){this.horizontalNeighbour=t},t.prototype.addVerticalNeighbour=function(t){this.verticalNeighbour=t},t.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},t.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},t.prototype.draw=function(t){this.drawCornerFill(t),this.drawCornerBorder(t)},t}(t)}])}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").factory("CropService",function(){function t(){}return t.init=function(t){this.canvas=t,this.ctx=this.canvas.getContext("2d")},t.DEG2RAD=.0174532925,t})}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").factory("CropTouch",function(){return function(t,i,e){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),this.id=0,this.x=t,this.y=i,this.id=e}})}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").factory("DragMarker",["Handle","__extends","PointPool",function(t,i,r){return function(s){function t(t,i,e,o){s.call(this,t,i,e),this.iconPoints=new Array,this.scaledIconPoints=new Array,this.getDragIconPoints(this.iconPoints,1),this.getDragIconPoints(this.scaledIconPoints,1.2),this.color=o||"rgba(90, 90, 90, 0.75)"}return i(t,s),t.prototype.draw=function(t){this.over||this.drag?this.drawIcon(t,this.scaledIconPoints):this.drawIcon(t,this.iconPoints)},t.prototype.getDragIconPoints=function(t,i){var e=17*i,o=14*i,s=8*i,n=4*i;t.push(r.instance.borrow(-n/2,e-s)),t.push(r.instance.borrow(-o/2,e-s)),t.push(r.instance.borrow(0,e)),t.push(r.instance.borrow(o/2,e-s)),t.push(r.instance.borrow(n/2,e-s)),t.push(r.instance.borrow(n/2,n/2)),t.push(r.instance.borrow(e-s,n/2)),t.push(r.instance.borrow(e-s,o/2)),t.push(r.instance.borrow(e,0)),t.push(r.instance.borrow(e-s,-o/2)),t.push(r.instance.borrow(e-s,-n/2)),t.push(r.instance.borrow(n/2,-n/2)),t.push(r.instance.borrow(n/2,-e+s)),t.push(r.instance.borrow(o/2,-e+s)),t.push(r.instance.borrow(0,-e)),t.push(r.instance.borrow(-o/2,-e+s)),t.push(r.instance.borrow(-n/2,-e+s)),t.push(r.instance.borrow(-n/2,-n/2)),t.push(r.instance.borrow(-e+s,-n/2)),t.push(r.instance.borrow(-e+s,-o/2)),t.push(r.instance.borrow(-e,0)),t.push(r.instance.borrow(-e+s,o/2)),t.push(r.instance.borrow(-e+s,n/2)),t.push(r.instance.borrow(-n/2,n/2))},t.prototype.drawIcon=function(t,i){t.beginPath(),t.moveTo(i[0].x+this.position.x,i[0].y+this.position.y);for(var e=0;e<i.length;e++){var o=i[e];t.lineTo(o.x+this.position.x,o.y+this.position.y)}t.closePath(),t.fillStyle=this.color,t.fill()},t.prototype.recalculatePosition=function(t){var i=t.getCentre();this.setPosition(i.x,i.y),r.instance.returnPoint(i)},t}(t)}])}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").factory("Handle",["Point",function(o){function t(t,i,e){this.over=!1,this.drag=!1,this.position=new o(t,i),this.offset=new o(0,0),this.radius=e}return t.prototype.setDrag=function(t){this.drag=t,this.setOver(t)},t.prototype.draw=function(t){},t.prototype.setOver=function(t){this.over=t},t.prototype.touchInBounds=function(t,i){return t>this.position.x-this.radius&&t<this.position.x+this.radius&&i>this.position.y-this.radius&&i<this.position.y+this.radius},t.prototype.getPosition=function(){return this.position},t.prototype.setPosition=function(t,i){this.position.x=t,this.position.y=i},t}])}(angular,angular.element),function(s,t,i){"use strict";angular.module("angular-img-cropper").factory("imageCropperDataShare",function(){var e,o,t={};return t.setPressed=function(t){e=t},t.setReleased=function(t){t===e&&(e=void 0)},t.setOver=function(t){o=t},t.setStyle=function(t,i){void 0!==e?e===t&&s.element(document.documentElement).css("cursor",i):t===o&&s.element(document.documentElement).css("cursor",i)},t})}(angular,angular.element),function(l,t,i){"use strict";angular.module("angular-img-cropper").factory("ImageCropper",["__extends","Handle","Point","PointPool","CropService","DragMarker","CornerMarker","Bounds","CropTouch","imageCropperDataShare",function(t,i,e,w,g,u,p,b,r,a){function o(t,i,e,o,s,n,r,a,h,c){void 0===i&&(i=0),void 0===e&&(e=0),void 0===o&&(o=100),void 0===s&&(s=50),void 0===n&&(n=!0),void 0===a&&(a=20),this.scope=h,this.attrs=c,this.keepAspect=!1,this.aspectRatio=0,this.currentDragTouches=new Array,this.isMouseDown=!1,this.ratioW=1,this.ratioH=1,this.fileType="image/png",this.imageSet=!1,this.pointPool=new w(200),g.init(t),this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas"),this.buffer.width=t.width,this.buffer.height=t.height,this.tl=new p(i,e,a,this.scope.colorDrag,this.scope.colorCropBg),this.tr=new p(i+o,e,a,this.scope.colorDrag,this.scope.colorCropBg),this.bl=new p(i,e+s,a,this.scope.colorDrag,this.scope.colorCropBg),this.br=new p(i+o,e+s,a,this.scope.colorDrag,this.scope.colorCropBg),this.tl.addHorizontalNeighbour(this.tr),this.tl.addVerticalNeighbour(this.bl),this.tr.addHorizontalNeighbour(this.tl),this.tr.addVerticalNeighbour(this.br),this.bl.addHorizontalNeighbour(this.br),this.bl.addVerticalNeighbour(this.tl),this.br.addHorizontalNeighbour(this.bl),this.br.addVerticalNeighbour(this.tr),this.markers=[this.tl,this.tr,this.bl,this.br],this.center=new u(i+o/2,e+s/2,a,this.scope.colorDrag),this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.keepAspect=n,this.keepAspectRatio=r||!1,this.aspectRatio=s/o,this.draw(this.ctx),this.croppedImage=new Image,this.currentlyInteracting=!1,this.enforceCropAspect=this.scope.enforceCropAspect||!1,this.enforceFileType=this.scope.enforceFileType?"image/"+this.scope.enforceFileType:void 0,window.jQuery?(l.element(window).off("mousemove.angular-img-cropper mouseup.angular-img-cropper").on("mousemove.angular-img-cropper",this.onMouseMove.bind(this)).on("mouseup.angular-img-cropper",this.onMouseUp.bind(this)),l.element(t).off("mousedown.angular-img-cropper touchstart.angular-img-cropper  touchmove.angular-img-cropper touchend.angular-img-cropper").on("mousedown.angular-img-cropper",this.onMouseDown.bind(this)).on("touchstart.angular-img-cropper",this.onTouchStart.bind(this)).on("touchmove.angular-img-cropper",this.onTouchMove.bind(this)).on("touchend.angular-img-cropper",this.onTouchEnd.bind(this))):(window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("mousedown",this.onMouseDown.bind(this)),t.addEventListener("touchmove",this.onTouchMove.bind(this),!1),t.addEventListener("touchstart",this.onTouchStart.bind(this),!1),t.addEventListener("touchend",this.onTouchEnd.bind(this),!1))}return o.prototype.resizeCanvas=function(t,i){this.canvas.width=t,this.canvas.height=i,this.buffer.width=t,this.buffer.height=i,this.draw(this.ctx)},o.prototype.draw=function(t){var i=this.getBounds();if(this.srcImage){t.clearRect(0,0,this.canvasWidth,this.canvasHeight),t.fillStyle=this.scope.colorBg,t.fillRect(0,0,this.canvas.width,this.canvas.height);var e=this.srcImage.height/this.srcImage.width,o=this.canvasHeight/this.canvasWidth,s=this.canvasWidth,n=this.canvasHeight,r=0,a=0;e<o?(s=this.canvasWidth,n=this.canvasWidth*e):(n=this.canvasHeight,s=this.canvasHeight/e),this.ratioW=s/this.srcImage.width,this.ratioH=n/this.srcImage.height,o<e?r=this.buffer.width/2-s/2:a=this.buffer.height/2-n/2,this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,r,a,s,n),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvasWidth,this.canvasHeight),t.fillStyle=this.scope.colorCropBg,t.fillRect(r,a,s,n),t.drawImage(this.buffer,i.left,i.top,Math.max(i.getWidth(),1),Math.max(i.getHeight(),1),i.left,i.top,i.getWidth(),i.getHeight());for(var h=0;h<this.markers.length;h++)this.markers[h].draw(t);this.center.draw(t),t.lineWidth=2,t.strokeStyle=this.scope.color,t.strokeRect(i.left,i.top,i.getWidth(),i.getHeight())}else t.fillStyle=this.scope.colorBg,t.fillRect(0,0,this.canvas.width,this.canvas.height)},o.prototype.dragCrop=function(t,i,e){var o=this.getBounds(),s=t-o.getWidth()/2,n=t+o.getWidth()/2,r=i-o.getHeight()/2,a=i+o.getHeight()/2;n>=this.maxXClamp&&(t=this.maxXClamp-o.getWidth()/2),s<=this.minXClamp&&(t=o.getWidth()/2+this.minXClamp),r<this.minYClamp&&(i=o.getHeight()/2+this.minYClamp),a>=this.maxYClamp&&(i=this.maxYClamp-o.getHeight()/2),this.tl.moveX(t-o.getWidth()/2),this.tl.moveY(i-o.getHeight()/2),this.tr.moveX(t+o.getWidth()/2),this.tr.moveY(i-o.getHeight()/2),this.bl.moveX(t-o.getWidth()/2),this.bl.moveY(i+o.getHeight()/2),this.br.moveX(t+o.getWidth()/2),this.br.moveY(i+o.getHeight()/2),e.setPosition(t,i),this.scope.cropAreaBounds&&this.imageSet&&(this.scope.cropAreaBounds=this.getCropBounds(),this.scope.$apply())},o.prototype.enforceMinSize=function(t,i,e){var o=t-e.getHorizontalNeighbour().getPosition().x,s=i-e.getVerticalNeighbour().getPosition().y,n=this.scope.minWidth-Math.abs(o),r=this.scope.minHeight-Math.abs(s);return 0==o||0==s?(t=e.getPosition().x,i=e.getPosition().y):(this.scope.keepAspect?0<n&&0<r/this.aspectRatio?n>r/this.aspectRatio?(o<0?t-=n:t+=n,s<0?i-=n*this.aspectRatio:i+=n*this.aspectRatio):(s<0?i-=r:i+=r,o<0?t-=r/this.aspectRatio:t+=r/this.aspectRatio):0<n?(o<0?t-=n:t+=n,s<0?i-=n*this.aspectRatio:i+=n*this.aspectRatio):0<r&&(s<0?i-=r:i+=r,o<0?t-=r/this.aspectRatio:t+=r/this.aspectRatio):(0<n&&(o<0?t-=n:t+=n),0<r&&(s<0?i-=r:i+=r)),(t<this.minXClamp||t>this.maxXClamp||i<this.minYClamp||i>this.maxYClamp)&&(t=e.getPosition().x,i=e.getPosition().y)),w.instance.borrow(t,i)},o.prototype.dragCorner=function(t,i,e){var o,s=0,n=0,r=0,a=0,h=0,c=0,g=0,u=0,p=0;if(this.scope.keepAspect){if(r=(o=e.getHorizontalNeighbour().getVerticalNeighbour()).getPosition().x,a=o.getPosition().y,t<=o.getPosition().x){if(i<=o.getPosition().y){if(s=r-100/this.aspectRatio,n=a-100/this.aspectRatio*this.aspectRatio,0<(p=this.getSide(w.instance.borrow(s,n),o.getPosition(),w.instance.borrow(t,i)))){c=(h=Math.abs(o.getPosition().y-i))/this.aspectRatio,g=o.getPosition().y-h,u=o.getPosition().x-c;var l=this.enforceMinSize(u,g,e);e.move(l.x,l.y),w.instance.returnPoint(l)}else if(p<0){h=(c=Math.abs(o.getPosition().x-t))*this.aspectRatio,g=o.getPosition().y-h,u=o.getPosition().x-c;l=this.enforceMinSize(u,g,e);e.move(l.x,l.y),w.instance.returnPoint(l)}}else if(s=r-100/this.aspectRatio,n=a+100/this.aspectRatio*this.aspectRatio,0<(p=this.getSide(w.instance.borrow(s,n),o.getPosition(),w.instance.borrow(t,i)))){h=(c=Math.abs(o.getPosition().x-t))*this.aspectRatio,g=o.getPosition().y+h,u=o.getPosition().x-c;l=this.enforceMinSize(u,g,e);e.move(l.x,l.y),w.instance.returnPoint(l)}else if(p<0){c=(h=Math.abs(o.getPosition().y-i))/this.aspectRatio,g=o.getPosition().y+h,u=o.getPosition().x-c;l=this.enforceMinSize(u,g,e);e.move(l.x,l.y),w.instance.returnPoint(l)}}else if(i<=o.getPosition().y){if(s=r+100/this.aspectRatio,n=a-100/this.aspectRatio*this.aspectRatio,(p=this.getSide(w.instance.borrow(s,n),o.getPosition(),w.instance.borrow(t,i)))<0){c=(h=Math.abs(o.getPosition().y-i))/this.aspectRatio,g=o.getPosition().y-h,u=o.getPosition().x+c;l=this.enforceMinSize(u,g,e);e.move(l.x,l.y),w.instance.returnPoint(l)}else if(0<p){h=(c=Math.abs(o.getPosition().x-t))*this.aspectRatio,g=o.getPosition().y-h,u=o.getPosition().x+c;l=this.enforceMinSize(u,g,e);e.move(l.x,l.y),w.instance.returnPoint(l)}}else if(s=r+100/this.aspectRatio,n=a+100/this.aspectRatio*this.aspectRatio,(p=this.getSide(w.instance.borrow(s,n),o.getPosition(),w.instance.borrow(t,i)))<0){h=(c=Math.abs(o.getPosition().x-t))*this.aspectRatio,g=o.getPosition().y+h,u=o.getPosition().x+c;l=this.enforceMinSize(u,g,e);e.move(l.x,l.y),w.instance.returnPoint(l)}else if(0<p){c=(h=Math.abs(o.getPosition().y-i))/this.aspectRatio,g=o.getPosition().y+h,u=o.getPosition().x+c;l=this.enforceMinSize(u,g,e);e.move(l.x,l.y),w.instance.returnPoint(l)}}else{l=this.enforceMinSize(t,i,e);e.move(l.x,l.y),w.instance.returnPoint(l)}this.center.recalculatePosition(this.getBounds()),this.scope.cropAreaBounds&&this.imageSet&&(this.scope.cropAreaBounds=this.getCropBounds(),this.scope.$apply())},o.prototype.getSide=function(t,i,e){var o=this.sign((i.x-t.x)*(e.y-t.y)-(i.y-t.y)*(e.x-t.x));return w.instance.returnPoint(t),w.instance.returnPoint(e),o},o.prototype.sign=function(t){return+t===t?0===t?t:0<t?1:-1:NaN},o.prototype.handleRelease=function(t){if(null!=t){for(var i=0,e=0;e<this.currentDragTouches.length;e++)t.id==this.currentDragTouches[e].id&&(this.currentDragTouches[e].dragHandle.setDrag(!1),t.dragHandle=null,i=e);this.currentDragTouches.splice(i,1),this.draw(this.ctx)}},o.prototype.handleMove=function(t){for(var i=!1,e=0;e<this.currentDragTouches.length;e++)if(t.id==this.currentDragTouches[e].id&&null!=this.currentDragTouches[e].dragHandle){var o=this.currentDragTouches[e],s=this.clampPosition(t.x-o.dragHandle.offset.x,t.y-o.dragHandle.offset.y);t.x=s.x,t.y=s.y,w.instance.returnPoint(s),o.dragHandle instanceof p?this.dragCorner(t.x,t.y,o.dragHandle):this.dragCrop(t.x,t.y,o.dragHandle),i=this.currentlyInteracting=!0,a.setPressed(this.canvas);break}if(!i){for(var n=0;n<this.markers.length;n++){var r=this.markers[n];if(r.touchInBounds(t.x,t.y)){t.dragHandle=r,this.currentDragTouches.push(t),r.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.getPosition().x,t.dragHandle.offset.y=t.y-t.dragHandle.getPosition().y,this.dragCorner(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle);break}}null==t.dragHandle&&this.center.touchInBounds(t.x,t.y)&&(t.dragHandle=this.center,this.currentDragTouches.push(t),t.dragHandle.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.getPosition().x,t.dragHandle.offset.y=t.y-t.dragHandle.getPosition().y,this.dragCrop(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle))}},o.prototype.updateClampBounds=function(){var t=this.srcImage.height/this.srcImage.width,i=this.canvas.height/this.canvas.width,e=this.canvas.width,o=this.canvas.height;t<i?(e=this.canvas.width,o=this.canvas.width*t):(o=this.canvas.height,e=this.canvas.height/t),this.minXClamp=this.canvas.width/2-e/2,this.minYClamp=this.canvas.height/2-o/2,this.maxXClamp=this.canvas.width/2+e/2,this.maxYClamp=this.canvas.height/2+o/2},o.prototype.getCropBounds=function(){var t=this.canvas.height-2*this.minYClamp,i=this.getBounds();return i.top=Math.round((t-i.top+this.minYClamp)/this.ratioH),i.bottom=Math.round((t-i.bottom+this.minYClamp)/this.ratioH),i.left=Math.round((i.left-this.minXClamp)/this.ratioW),i.right=Math.round((i.right-this.minXClamp)/this.ratioW),i},o.prototype.clampPosition=function(t,i){return t<this.minXClamp&&(t=this.minXClamp),t>this.maxXClamp&&(t=this.maxXClamp),i<this.minYClamp&&(i=this.minYClamp),i>this.maxYClamp&&(i=this.maxYClamp),w.instance.borrow(t,i)},o.prototype.isImageSet=function(){return this.imageSet},o.prototype.setImage=function(t,i){if(!t)throw"Image is null";this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.buffer.getContext("2d").clearRect(0,0,this.buffer.width,this.buffer.height),this.enforceFileType?this.fileType=this.enforceFileType:"image/png"!=i&&"image/jpeg"!=i||(this.fileType=i),this.srcImage=t,this.updateClampBounds();var e=this.srcImage.height/this.srcImage.width,o=this.getBounds(),s=o.getHeight()/o.getWidth(),n=this.canvas.width,r=this.canvas.height;this.canvasWidth=n,this.canvasHeight=r;var a=this.canvas.width/2,h=this.canvas.height/2,c=w.instance.borrow(a-o.getWidth()/2,h+o.getHeight()/2),g=w.instance.borrow(a+o.getWidth()/2,h+o.getHeight()/2),u=w.instance.borrow(a-o.getWidth()/2,h-o.getHeight()/2),p=w.instance.borrow(a+o.getWidth()/2,h-o.getHeight()/2);if(this.tl.setPosition(c.x,c.y),this.tr.setPosition(g.x,g.y),this.bl.setPosition(u.x,u.y),this.br.setPosition(p.x,p.y),w.instance.returnPoint(c),w.instance.returnPoint(g),w.instance.returnPoint(u),w.instance.returnPoint(p),this.center.setPosition(a,h),e<s){var l=Math.min(n*e,r),d=l/s;c=w.instance.borrow(a-d/2,h+l/2),g=w.instance.borrow(a+d/2,h+l/2),u=w.instance.borrow(a-d/2,h-l/2),p=w.instance.borrow(a+d/2,h-l/2)}else if(s<e){var m=(f=Math.min(r/e,n))*s;c=w.instance.borrow(a-f/2,h+m/2),g=w.instance.borrow(a+f/2,h+m/2),u=w.instance.borrow(a-f/2,h-m/2),p=w.instance.borrow(a+f/2,h-m/2)}else{var f;m=(f=Math.min(r,n))*s;c=w.instance.borrow(a-f/2,h+m/2),g=w.instance.borrow(a+f/2,h+m/2),u=w.instance.borrow(a-f/2,h-m/2),p=w.instance.borrow(a+f/2,h-m/2)}if(this.tl.setPosition(c.x,c.y),this.tr.setPosition(g.x,g.y),this.bl.setPosition(u.x,u.y),this.br.setPosition(p.x,p.y),w.instance.returnPoint(c),w.instance.returnPoint(g),w.instance.returnPoint(u),w.instance.returnPoint(p),this.scope.cropAreaBounds&&void 0!==this.scope.cropAreaBounds.left&&void 0!==this.scope.cropAreaBounds.top&&void 0!==this.scope.cropAreaBounds.right&&void 0!==this.scope.cropAreaBounds.bottom){e<this.canvasHeight/this.canvasWidth?(n=this.canvasWidth,r=this.canvasWidth*e):(r=this.canvasHeight,n=this.canvasHeight/e),this.ratioW=n/this.srcImage.width,this.ratioH=r/this.srcImage.height;var v=new b;v.top=Math.round(r+this.minYClamp-this.ratioH*this.scope.cropAreaBounds.top),v.bottom=Math.round(r+this.minYClamp-this.ratioH*this.scope.cropAreaBounds.bottom),v.left=Math.round(this.ratioW*this.scope.cropAreaBounds.left+this.minXClamp),v.right=Math.round(this.ratioW*this.scope.cropAreaBounds.right+this.minXClamp),this.tl.setPosition(v.left,v.top),this.tr.setPosition(v.right,v.top),this.bl.setPosition(v.left,v.bottom),this.br.setPosition(v.right,v.bottom),this.center.setPosition(v.left+v.getWidth()/2,v.top+v.getHeight()/2)}this.vertSquashRatio=this.detectVerticalSquash(this.srcImage),this.draw(this.ctx);var y=this.getCroppedImage(this.scope.cropWidth,this.scope.cropHeight);void 0!==this.attrs.imgDst&&(this.scope.imgDst=y.src),this.scope.cropAreaBounds&&this.imageSet&&(this.scope.cropAreaBounds=this.getCropBounds())},o.prototype.getCroppedImage=function(t,i){var e=this.getBounds();if(!this.srcImage)throw"Source image not set.";var o=this.srcImage.height/this.srcImage.width,s=this.canvas.height/this.canvas.width,n=this.canvas.width,r=this.canvas.height;if(o<s?(n=this.canvas.width,r=this.canvas.width*o):n=s<o?(r=this.canvas.height,this.canvas.height/o):(r=this.canvas.height,this.canvas.width),this.ratioW=n/this.srcImage.width,this.ratioH=r/this.srcImage.height,this.enforceCropAspect?t=!1:this.keepAspectRatio&&(t=Math.round(Math.max(e.getWidth(),1)/this.ratioW),i=Math.round(Math.max(e.getHeight(),1)/this.ratioH)),t&&i){this.cropCanvas.width=t,this.cropCanvas.height=i;var a=(this.buffer.height-r)/2/this.ratioH,h=(this.buffer.width-n)/2/this.ratioW;this.drawImageIOSFix(this.cropCanvas.getContext("2d"),this.srcImage,Math.max(Math.round(e.left/this.ratioW-h),0),Math.max(Math.round(e.top/this.ratioH-a),0),Math.max(Math.round(e.getWidth()/this.ratioW),1),Math.max(Math.round(e.getHeight()/this.ratioH),1),0,0,t,i),this.croppedImage.width=t,this.croppedImage.height=i}else this.cropCanvas.width=Math.max(e.getWidth(),1),this.cropCanvas.height=Math.max(e.getHeight(),1),this.cropCanvas.getContext("2d").drawImage(this.buffer,e.left,e.top,Math.max(e.getWidth(),1),Math.max(e.getHeight(),1),0,0,e.getWidth(),e.getHeight()),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height;return this.croppedImage.src=this.cropCanvas.toDataURL(this.fileType),this.croppedImage},o.prototype.getBounds=function(){for(var t=Number.MAX_VALUE,i=Number.MAX_VALUE,e=-Number.MAX_VALUE,o=-Number.MAX_VALUE,s=0;s<this.markers.length;s++){var n=this.markers[s];n.getPosition().x<t&&(t=n.getPosition().x),n.getPosition().x>e&&(e=n.getPosition().x),n.getPosition().y<i&&(i=n.getPosition().y),n.getPosition().y>o&&(o=n.getPosition().y)}var r=new b;return r.left=t,r.right=e,r.top=i,r.bottom=o,r},o.prototype.setBounds=function(t){for(var i,e,o,s,n=this.getBounds(),r=0;r<this.markers.length;r++){var a=this.markers[r];a.getPosition().x==n.left?a.getPosition().y==n.top?i=a:o=a:a.getPosition().y==n.top?e=a:s=a}i.setPosition(t.left,t.top),e.setPosition(t.right,t.top),o.setPosition(t.left,t.bottom),s.setPosition(t.right,t.bottom),this.center.recalculatePosition(t),this.center.draw(this.ctx)},o.prototype.getMousePos=function(t,i){var e=t.getBoundingClientRect(),o=w.instance.borrow(i.clientX-e.left,i.clientY-e.top);if(o){var s=t.height/t.offsetHeight,n=t.width/t.offsetWidth;o.scale(n,s)}return o},o.prototype.getTouchPos=function(t,i){var e=t.getBoundingClientRect();return w.instance.borrow(i.clientX-e.left,i.clientY-e.top)},o.prototype.onTouchMove=function(t){if(!destroyed&&this.isImageSet()){t.preventDefault();var i=l.isDefined(t.touches)?t.touches:t.originalEvent.touches;if(1<=i.length)for(var e=0;e<i.length;e++){var o=i[e],s=this.getTouchPos(this.canvas,o),n=new r(s.x,s.y,o.identifier);w.instance.returnPoint(s),this.move(n,t)}this.draw(this.ctx)}},o.prototype.onMouseMove=function(t){if(this.isImageSet()){var i=this.getMousePos(this.canvas,t);this.move(new r(i.x,i.y,0),t);var e=this.getDragTouchForID(0);e?(e.x=i.x,e.y=i.y):e=new r(i.x,i.y,0),w.instance.returnPoint(i),this.drawCursors(e,t),this.draw(this.ctx)}},o.prototype.move=function(t,i){this.isMouseDown&&this.handleMove(t)},o.prototype.getDragTouchForID=function(t){for(var i=0;i<this.currentDragTouches.length;i++)if(t==this.currentDragTouches[i].id)return this.currentDragTouches[i]},o.prototype.drawCursors=function(t,i){var e=!1;null!=t&&(t.dragHandle==this.center&&(a.setStyle(this.canvas,"move"),e=!0),null!=t.dragHandle&&t.dragHandle instanceof p&&(this.drawCornerCursor(t.dragHandle,t.dragHandle.getPosition().x,t.dragHandle.getPosition().y,i),e=!0));var o=!1;if(!e){for(var s=0;s<this.markers.length;s++)o=o||this.drawCornerCursor(this.markers[s],t.x,t.y,i);o||a.setStyle(this.canvas,"auto")}o||e||!this.center.touchInBounds(t.x,t.y)?this.center.setOver(!1):(this.center.setOver(!0),a.setOver(this.canvas),a.setStyle(this.canvas,"move"))},o.prototype.drawCornerCursor=function(t,i,e,o){return t.touchInBounds(i,e)?(t.setOver(!0),t.getHorizontalNeighbour().getPosition().x>t.getPosition().x?t.getVerticalNeighbour().getPosition().y>t.getPosition().y?(a.setOver(this.canvas),a.setStyle(this.canvas,"nwse-resize")):(a.setOver(this.canvas),a.setStyle(this.canvas,"nesw-resize")):t.getVerticalNeighbour().getPosition().y>t.getPosition().y?(a.setOver(this.canvas),a.setStyle(this.canvas,"nesw-resize")):(a.setOver(this.canvas),a.setStyle(this.canvas,"nwse-resize")),!0):(t.setOver(!1),!1)},o.prototype.onTouchStart=function(t){this.isImageSet()&&(this.isMouseDown=!0)},o.prototype.onTouchEnd=function(t){if(this.isImageSet()){for(var i=l.isDefined(t.changedTouches)?t.changedTouches:t.originalEvent.changedTouches,e=0;e<i.length;e++){var o=i[e],s=this.getDragTouchForID(o.identifier);null!=s&&((s.dragHandle instanceof p||s.dragHandle instanceof u)&&s.dragHandle.setOver(!1),this.handleRelease(s))}if(this.isImageSet()&&this.currentlyInteracting){var n=this.getCroppedImage(this.scope.cropWidth,this.scope.cropHeight);void 0!==this.attrs.imgDst&&(this.scope.imgDst=n.src),this.scope.$apply()}0==this.currentDragTouches.length&&(this.isMouseDown=!1,this.currentlyInteracting=!1)}},o.prototype.drawImageIOSFix=function(t,i,e,o,s,n,r,a,h,c){t.drawImage(i,e*this.vertSquashRatio,o*this.vertSquashRatio,s*this.vertSquashRatio,n*this.vertSquashRatio,r,a,h,c)},o.prototype.detectVerticalSquash=function(t){t.naturalWidth;var i=t.naturalHeight,e=document.createElement("canvas");e.width=1,e.height=i;var o=e.getContext("2d");o.drawImage(t,0,0);for(var s=o.getImageData(0,0,1,i).data,n=0,r=i,a=i;n<a;){0===s[4*(a-1)+3]?r=a:n=a,a=r+n>>1}var h=a/i;return 0===h?1:h},o.prototype.onMouseDown=function(t){this.isImageSet()&&(this.isMouseDown=!0)},o.prototype.onMouseUp=function(t){if(this.isImageSet()){if(a.setReleased(this.canvas),this.isMouseDown=!1,this.handleRelease(new r(0,0,0)),1==this.currentlyInteracting){var i=this.getCroppedImage(this.scope.cropWidth,this.scope.cropHeight);void 0!==this.attrs.imgDst&&(this.scope.imgDst=i.src),this.scope.$apply()}this.currentlyInteracting=!1}},o}])}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").factory("PointPool",["Point",function(s){function n(t){this.borrowed=0,n.instance=this;for(var i=null,e=0;e<t;e++)if(0===e)this.firstAvailable=new s,i=this.firstAvailable;else{var o=new s;i.setNext(o),i=o}}return n.prototype.borrow=function(t,i){if(null==this.firstAvailable)throw"Pool exhausted";this.borrowed++;var e=this.firstAvailable;return this.firstAvailable=e.getNext(),e.x=t,e.y=i,e},n.prototype.returnPoint=function(t){this.borrowed--,t.x=0,t.y=0,t.setNext(this.firstAvailable),this.firstAvailable=t},n}])}(angular,angular.element),function(t,i,e){"use strict";angular.module("angular-img-cropper").factory("Point",function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i}return t.prototype.setNext=function(t){this.next=t},t.prototype.getNext=function(){return this.next},t.prototype.scale=function(t,i){this.x*=t,this.y*=i},t})}(angular,angular.element);