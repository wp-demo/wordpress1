"use strict";angular.module("LiveSearch",["ng"]).directive("liveSearch",["$compile","$timeout",function(s,d){return{restrict:"E",replace:!0,scope:{liveSearchCallback:"=",liveSearchSelect:"=?",liveSearchSelectCallback:"=",blur:"&ngBlur",liveSearchItemTemplate:"@",liveSearchWaitTimeout:"=?",liveSearchMaxResultSize:"=?",liveSearchMaxlength:"=?",placeholder:"@"},template:"<input type='text' placeholder='{{placeholder}}' ng-blur='blur'/>",link:function(c,n,a,e){var r;c.results=[],c.visible=!1,c.selectedIndex=-1,c.select=function(e){c.selectedIndex=e,c.visible=!1},c.isSelected=function(e){return c.selectedIndex===e},c.$watch("selectedIndex",function(e,l){var t=c.results[e];if(t)if(a.liveSearchSelectCallback){var i=c.liveSearchSelectCallback.call(null,{items:c.results,item:t});n.val(i)}else a.liveSearchSelect?n.val(t[a.liveSearchSelect]):n.val(t);"undefined"!==n.controller("ngModel")&&n.controller("ngModel").$setViewValue(n.val())}),c.$watch("visible",function(e,l){if(!1!==e){c.width=n[0].clientWidth;var t=i(n[0]);c.top=t.y+n[0].clientHeight+1+"px",c.left=t.x+"px"}}),n[0].onkeydown=function(e){40==e.keyCode?c.selectedIndex+1===c.results.length?c.selectedIndex=0:c.selectedIndex++:38==e.keyCode&&(0===c.selectedIndex?c.selectedIndex=c.results.length-1:-1==c.selectedIndex?c.selectedIndex=0:c.selectedIndex--),13==e.keyCode&&(c.visible=!1),c.$apply()},n[0].onkeyup=function(e){if(13==e.keyCode||37==e.keyCode||38==e.keyCode||39==e.keyCode||40==e.keyCode)return!1;var l=n;d.cancel(r);var t=l.val().split(","),i=t[t.length-1].trim();return i.length<3||null!==c.liveSearchMaxlength&&i.length>c.liveSearchMaxlength?(c.visible=!1,void c.$apply()):void(r=d(function(){var t=[],e=c.liveSearchCallback.call(null,i);e.then(function(e){e&&(t=e.slice(0,(c.liveSearchMaxResultSize||20)-1)),c.visible=!0}),e.finally(function(){c.selectedIndex=-1,c.results=t.filter(function(e,l){return t.indexOf(e)==l})})},c.liveSearchWaitTimeout||100))};var i=function(e){for(var l=0,t=0;e&&!e.classList.contains("modal-dialog");)l+=e.offsetLeft-e.scrollLeft+e.clientLeft,t+=e.offsetTop-e.scrollTop+e.clientTop,e=e.offsetParent;return{x:l,y:t}},l=n.attr("live-search-item-template")||"{{result}}",t=s("<ul ng-show='visible' ng-style=\"{'top':top,'left':left,'width':width}\" class='searchresultspopup'><li ng-class=\"{ 'selected' : isSelected($index) }\" ng-click='select($index)' ng-repeat='result in results'>"+l+"</li></ul>")(c);(document.getElementsByClassName("modal-dialog")[0]||document.body).appendChild(t[0])}}}]);